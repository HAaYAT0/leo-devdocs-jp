---
id: overview
title: Aleo 仮想マシン (AVM)
sidebar_label: Aleo 仮想マシン (AVM)
---

Aleo 仮想マシン（Aleo Virtual Machine, AVM）は、プライバシー重視のアプリケーションを実行するために Aleo ブロックチェーンへ組み込まれた計算プラットフォームです。キューに蓄えた命令を実行するスタックマシンとして動作し、主な役割は関数内の各命令からランク 1 制約システム（Rank-1 Constraint System, R1CS）と呼ばれる算術回路を構築することです。

**R1CS** を構築した後、**Varuna** と呼ばれる **Marlin** アルゴリズムの改良版を用いて対応する証明を生成します。この方式は、**ユニバーサル**かつ**更新可能**な構造化参照文字列（Structured Reference String, **SRS**）を活用することで、任意の計算を簡潔に検証できるようにしています。

これらは Aleo ネットワークにおいて [ARC-0002](https://github.com/AleoNet/ARCs/tree/master/arc-0002) として正式に定義され、実装されています。

### **AVM の主な特徴**

- **プライバシー保護**: AVM はトランザクションやコントラクトを実行しながら、関与するデータの秘匿性を維持します。zk-SNARK を利用することで、入力値や内部状態を公開せずに計算の正しさを検証できます。
- **決定的な実行**: 他のブロックチェーン向け仮想マシンと同様に、AVM はコントラクトの実行が決定的になるよう保証します。同じ初期状態と入力が与えられれば、ノード間で同一の結果を得られます。
- **スケーラビリティ**: zk-SNARK を用いると検証の計算コストが繰り返しの再実行より小さくなるため、従来のシステムと比べてより大規模かつ複雑な処理へ対応できます。

## **AVM のアーキテクチャと設計**

AVM は後入れ先出し（LIFO）方式で動作する仮想マシンであり、スタックに積んだデータのうち最後に追加されたものから順にアクセスまたは取り出します。この設計が、Aleo のプライバシー機能を支える複雑な算術回路の実行に適しています。AVM のアーキテクチャはゼロ知識証明を活用しながらプライベートアプリケーションを実行できるよう設計されています。高水準プログラミング言語の Leo を利用してコードを記述し、コンパイルすると AVM オペコードと呼ばれる中間表現になります。これらのオペコードが R1CS を構築するために使用され、ゼロ知識証明の生成に不可欠です。オペコードの一覧は [こちら](../../guides/aleo/04_opcodes.md) を参照してください。

AVM のアーキテクチャは主に次の要素と特徴から成り立ちます。

### **Instruction Set Architecture (ISA)**

AVM の命令セットアーキテクチャは、ゼロ知識証明、特に zk-SNARK に必要な演算をサポートするように設計されています。この命令セットは、ゼロ知識証明の生成と検証に不可欠な楕円曲線演算をはじめとする複雑な数学的処理を効率的に扱えるよう最適化されています。

### **Execution Environment**

AVM の実行環境は、スマートコントラクトが動作するランタイムを提供します。この環境は厳密に制御されており決定的に振る舞います。つまり、同じ初期状態と入力であれば常に同じ出力が得られます。この決定性が、ブロックチェーンネットワーク全体のコンセンサス維持に不可欠です。

### **Memory Management**

AVM には一時的なデータと永続的なデータの両方を扱うための構造化されたメモリモデルがあります。

- **スタック**: 命令の実行中に使用される一時的な記憶領域です。変数や一時的な計算結果、関数呼び出しのコンテキスト（スタックフレーム）などが格納されます。
- **ヒープ**: 実行時に動的にメモリを割り当てる領域で、高度なコントラクト機能に必要な複雑なデータ構造をサポートします。
- **ストレージ**: ブロックチェーン上に永続化されるコントラクトの状態を指します。スタックやヒープと異なり、トランザクションをまたいで保持され、ブロックチェーンの状態の一部となります。

### **State Transition System**

AVM の状態遷移システムは、トランザクションに応じてブロックチェーンの状態がどのように変化するかを定義します。

- **トランザクション**: ユーザーが送信する操作で、スマートコントラクトへのアクセスや単純な送金などを含みます。これらはブロックチェーンの状態を変化させます。
- **状態遷移**: AVM がトランザクションを処理すると、あらかじめ定められたルールに従って状態遷移が発生し、ブロックチェーンのグローバルステートが更新されます。
- **プライバシーの担保**: 状態遷移の過程でも、ゼロ知識証明によって保証されるプライバシーが常に維持されます。秘匿すべきデータは暗号化されたままで、トランザクションの正当性だけが検証されます。

グローバルステートの表現には Merkle 木が用いられます。大きな課題の 1 つは、暗号化された情報をこのグローバルステートに組み込むことです。

トランザクションデータは直接保存されず、暗号化されたトランジションを通じて保持されます。

![AVS Global State](./images/avs_global_state.png)
出典: trapdoortech.com

### **スマートコントラクトのコンパイルとデプロイ**

- **Leo プログラミング言語**: スマートコントラクトは、Aleo の意味論とゼロ知識を表現するために設計されたドメイン特化言語（DSL）である Leo で記述します。Leo のコードは AVM バイトコードへコンパイルされます。
- **バイトコードの実行**: コンパイルされたバイトコードが AVM によって直接実行されます。このバイトコードは AVM の実行環境向けに最適化されており、高効率かつプライバシーを維持した処理が可能です。

### **ネットワーキングとコンセンサス層との統合**

AVM 自体は直接ネットワーク層に属しませんが、Aleo のネットワークアーキテクチャ全体の中で動作します。

- **ブロックの伝播と検証**: AVM の実行結果は、ネットワーク全体でのブロック検証と伝播に影響します。
- **コンセンサスメカニズム**: AVM は、ゼロ知識証明によってトランザクションの正当性を保証することでブロックチェーンのコンセンサスメカニズムと連携し、台帳状態に関する安全で検証可能な合意形成を支援します。

![AVM Execution Flow](./images/avm_execution_flow_overview.png)

### **実行フロー**

- **コンパイル**: 開発者は Leo でコントラクトを記述し、AVM バイトコードへコンパイルします。
- **デプロイ**: バイトコードを Aleo ネットワークへデプロイすると、AVM が実行します。
- **実行**: コントラクトが呼び出されると、AVM がバイトコードを処理し、zk-SNARK を活用してプライバシーを維持します。出力から、秘匿情報を公開することなくコントラクトが正しく実行されたと確認できます。
